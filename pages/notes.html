<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - Zhihao Shu</title>
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.5/dist/umd/supabase.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #c0392b; --bg-color: #faf9f6; --card-bg: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: #4a5568; margin: 0; line-height: 1.6; }
        
        /* Navigation */
        .nav-header { position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); padding: 15px 50px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .nav-title { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.5em; color: var(--primary); text-decoration: none; }
        .nav-links a { text-decoration: none; color: var(--primary); margin-left: 25px; opacity: 0.7; font-weight: 500; transition: 0.2s; }
        .nav-links a:hover, .nav-links a.current { opacity: 1; color: var(--accent); }
        
        .container { max-width: 1100px; margin: 120px auto 60px; padding: 0 20px; }
        .page-header { text-align: center; margin-bottom: 50px; }
        .page-header h1 { font-family: 'Playfair Display', serif; font-size: 2.5em; color: var(--primary); margin-bottom: 10px; }
        
        /* Grid */
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .note-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: transform 0.3s; cursor: pointer; border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .note-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .note-title { font-family: 'Playfair Display', serif; font-size: 1.4em; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
        .note-preview { font-size: 0.9em; color: #718096; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        .note-footer { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { font-size: 0.7em; background: #f1f5f9; padding: 4px 10px; border-radius: 15px; color: #64748b; font-weight: 600; text-transform: uppercase; }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; }
        
        .modal-content { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 12px; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: translateY(20px); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        
        .modal-header { padding: 30px 40px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: flex-start; position: sticky; top: 0; background: white; z-index: 10; }
        .modal-title { font-family: 'Playfair Display', serif; font-size: 1.8em; color: var(--primary); margin: 0; }
        .modal-close { font-size: 2em; cursor: pointer; color: #cbd5e0; line-height: 0.8; }
        .modal-close:hover { color: var(--accent); }
        
        .modal-body { padding: 40px; font-size: 1.05em; color: #2d3748; line-height: 1.8; }
        
        /* Markdown Styling inside Modal */
        .modal-body h1, .modal-body h2, .modal-body h3 { color: var(--primary); font-family: 'Playfair Display', serif; margin-top: 1.5em; }
        .modal-body p { margin-bottom: 1em; }
        .modal-body code { background: #edf2f7; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #c0392b; font-size: 0.9em; }
        .modal-body pre { background: #2d2d2d !important; border-radius: 8px; padding: 20px; overflow-x: auto; margin: 20px 0; }
        
        /* Comments Section */
        .comments-section { background: #f8fafc; padding: 30px 40px; border-top: 1px solid #eee; }
        .comments-header { font-family: 'Playfair Display', serif; font-size: 1.2em; margin-bottom: 20px; color: var(--primary); }
        .comment-list { margin-bottom: 25px; max-height: 300px; overflow-y: auto; }
        .comment-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .comment-author { font-weight: 700; color: var(--primary); font-size: 0.85em; margin-bottom: 5px; }
        .comment-text { font-size: 0.95em; color: #4a5568; }
        
        .comment-form { display: flex; flex-direction: column; gap: 10px; }
        .comment-form input, .comment-form textarea { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: 'Inter', sans-serif; }
        .comment-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; align-self: flex-end; }
        .comment-btn:hover { background: var(--accent); }

        @media (max-width: 768px) { 
            .nav-header { padding: 15px 20px; } .nav-links { display: none; } 
            .modal-body { padding: 25px; }
        }
    </style>
</head>
<body>
    <nav class="nav-header">
        <a href="../index.html" class="nav-title">Zhihao Shu</a>
        <div class="nav-links">
            <a href="../index.html">Home</a>
            <a href="notes.html" class="current">Notes</a>
            <a href="papers.html">Reading List</a>
            <a href="blog.html">Blog</a>
            <a href="teaching.html">Teaching</a>
            <a href="faq.html">FAQ</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Notes & Resources</h1>
            <p>Research logs, cheatsheets, and technical thoughts.</p>
        </div>
        <div id="notesGrid" class="notes-grid">
            <div style="text-align:center; grid-column: 1/-1; color:#999;">Loading notes from database...</div>
        </div>
    </div>

    <div id="modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="mTitle" class="modal-title"></h2>
                <span class="modal-close" onclick="closeModalDirect()">&times;</span>
            </div>
            
            <div id="mBody" class="modal-body"></div>
            
            <div class="comments-section">
                <div class="comments-header">Discussion</div>
                <div id="commentsList" class="comment-list">Loading comments...</div>
                
                <div class="comment-form">
                    <input type="text" id="cAuthor" placeholder="Your Name (Optional)">
                    <textarea id="cContent" rows="2" placeholder="Add a comment..."></textarea>
                    <button class="comment-btn" onclick="postComment()">Post Comment</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bmnwirsmmmhknbhvnuyb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbndpcnNtbW1oa25iaHZudXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTQ3OTksImV4cCI6MjA3NDQzMDc5OX0.R-IWO_-i8Ih6WAz0V-ch4mgj1T-lNYWdHJrTeg4c9GE';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentNoteId = null;
        let allNotes = [];

        // 1. Load Notes
        async function loadNotes() {
            const { data, error } = await client.from('notes').select('*').order('created_at', { ascending: false });
            const grid = document.getElementById('notesGrid');
            
            if (error || !data || data.length === 0) {
                grid.innerHTML = `<div style="text-align:center; grid-column: 1/-1; color:#999; padding:40px;">No notes found. Add them via the <a href="admin.html">Admin Panel</a>.</div>`;
                return;
            }

            allNotes = data;
            grid.innerHTML = data.map(n => {
                // Create a plain text preview from markdown
                const preview = n.content.replace(/[#*`]/g, '').split('\n').slice(0, 3).join(' ') + '...';
                const tagsHtml = n.tags ? n.tags.map(t => `<span class="tag">${t}</span>`).join('') : '';
                
                return `
                <div class="note-card" onclick="openNote('${n.id}')">
                    <div class="note-title">${escapeHtml(n.title)}</div>
                    <div class="note-preview">${escapeHtml(preview)}</div>
                    <div class="note-footer">${tagsHtml}</div>
                </div>`;
            }).join('');
        }

        // 2. Open Modal
        function openNote(id) {
            currentNoteId = id;
            const note = allNotes.find(n => n.id === id);
            if (!note) return;

            document.getElementById('mTitle').innerText = note.title;
            document.getElementById('mBody').innerHTML = renderMarkdown(note.content);
            
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            
            loadComments(id);
            if(window.Prism) Prism.highlightAll();
        }

        // 3. Render Markdown (Same logic as Blog)
        function renderMarkdown(text) {
            if (!text) return '';
            
            // Code blocks
            const parts = text.split(/(\/code\s*\w*[\s\S]*?\/end_code)/g);
            
            return parts.map(part => {
                if (part.trim().startsWith('/code')) {
                    const match = part.match(/\/code\s*(\w*)/);
                    const lang = match ? match[1] : 'plaintext';
                    let code = part.replace(/\/code\s*\w*/, '').replace(/\/end_code/, '').trim();
                    return `<pre><code class="language-${lang}">${escapeHtml(code)}</code></pre>`;
                } else {
                    return escapeHtml(part)
                        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                        .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
                        .replace(/`(.*?)`/g, '<code>$1</code>')
                        .replace(/\n/g, '<br>');
                }
            }).join('');
        }

        // 4. Comments Logic
        async function loadComments(noteId) {
            const list = document.getElementById('commentsList');
            list.innerHTML = '<div style="color:#999; font-size:0.9em;">Loading...</div>';
            
            const { data } = await client.from('note_comments').select('*').eq('note_id', noteId).order('created_at', { ascending: true });
            
            if (!data || data.length === 0) {
                list.innerHTML = '<div style="color:#999; font-size:0.9em;">No comments yet. Be the first!</div>';
                return;
            }

            list.innerHTML = data.map(c => `
                <div class="comment-item">
                    <div class="comment-author">${escapeHtml(c.author || 'Anonymous')}</div>
                    <div class="comment-text">${escapeHtml(c.content)}</div>
                </div>
            `).join('');
        }

        async function postComment() {
            const content = document.getElementById('cContent').value;
            const author = document.getElementById('cAuthor').value || 'Anonymous';
            if(!content.trim()) return;

            const btn = document.querySelector('.comment-btn');
            btn.textContent = 'Posting...';
            btn.disabled = true;

            const { error } = await client.from('note_comments').insert([{
                note_id: currentNoteId,
                content: content,
                author: author
            }]);

            btn.textContent = 'Post Comment';
            btn.disabled = false;

            if(error) {
                alert('Error: ' + error.message);
            } else {
                document.getElementById('cContent').value = '';
                loadComments(currentNoteId);
            }
        }

        // Utils
        function closeModalDirect() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }
        function closeModal(e) { if(e.target.id === 'modal') closeModalDirect(); }
        function escapeHtml(t) { return (t||'').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

        // Init
        loadNotes();
    </script>
</body>
</html>