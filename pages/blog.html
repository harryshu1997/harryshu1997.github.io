<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - Zhihao Shu</title>
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.5/dist/umd/supabase.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #c0392b;
            --bg-color: #faf9f6;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #4a5568;
            line-height: 1.8;
            margin: 0;
        }

        /* Glass Navigation */
        .nav-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            padding: 15px 50px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-title { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.5em; color: var(--primary); text-decoration: none; }
        .nav-links a { text-decoration: none; color: var(--primary); margin-left: 25px; opacity: 0.7; transition: 0.2s; font-weight: 500; }
        .nav-links a:hover, .nav-links a.current { opacity: 1; color: var(--accent); }

        .container { max-width: 900px; margin: 120px auto 60px; padding: 0 20px; }
        
        .page-header { text-align: center; margin-bottom: 60px; }
        .page-header h1 { font-family: 'Playfair Display', serif; font-size: 2.5em; color: var(--primary); margin-bottom: 10px; }
        .page-header p { color: #718096; font-size: 1.1em; }

        /* Blog Card Styles */
        .post-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            overflow: hidden;
            transition: transform 0.3s;
        }
        .post-card:hover { transform: translateY(-3px); border-color: var(--accent); }

        .post-header { padding: 30px 40px 20px; border-bottom: 1px solid #f7fafc; }
        .post-title { font-family: 'Playfair Display', serif; font-size: 1.6em; color: var(--primary); margin-bottom: 10px; font-weight: 700; }
        .post-meta { font-size: 0.85em; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        
        .post-content { padding: 30px 40px; color: #4a5568; font-size: 1.05em; }
        
        /* Markdown Styling */
        .post-content h1, .post-content h2, .post-content h3 { color: var(--primary); font-family: 'Playfair Display', serif; margin-top: 1.5em; }
        .post-content p { margin-bottom: 1em; }
        .post-content blockquote { border-left: 4px solid var(--accent); padding-left: 15px; color: #718096; font-style: italic; margin: 1.5em 0; }
        
        .post-actions { 
            padding: 0 40px 30px; 
            display: flex; 
            gap: 15px; 
            border-top: 1px dashed #f0f0f0; 
            padding-top: 20px; 
            margin-top: 10px;
        }

        .btn { 
            background: transparent; border: 1px solid #cbd5e0; 
            padding: 8px 20px; border-radius: 6px; cursor: pointer; 
            color: var(--primary); font-family: 'Inter', sans-serif; font-weight: 500;
            transition: 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-icon { font-size: 1.1em; }

        /* Logic Helpers */
        .notion-code { background: #2d2d2d !important; border-radius: 8px; padding: 20px; margin: 20px 0; overflow-x: auto; font-size: 0.9em; line-height: 1.5; color: #ccc; }
        .is-hidden { display: none; }
        .post-full { display: none; }
        .post-full.is-visible { display: block; animation: fadeIn 0.5s; }
        .post-image { width: 100%; border-radius: 8px; margin-bottom: 20px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
            .nav-header { padding: 15px 20px; }
            .nav-links { display: none; }
            .post-header, .post-content, .post-actions { padding: 20px; }
        }
    </style>
</head>
<body>
    <nav class="nav-header">
        <a href="../index.html" class="nav-title">Zhihao Shu</a>
        <div class="nav-links">
            <a href="../index.html">Home</a>
            <a href="notes.html">Notes</a>
            <a href="papers.html">Reading List</a>
            <a href="blog.html" class="current">Blog</a>
            <a href="teaching.html">Teaching</a>
            <a href="faq.html">FAQ</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Blog & Code</h1>
            <p>Insights, snippets, and updates.</p>
        </div>
        <div id="postsContainer"></div>
    </div>

    <a href="admin.html" id="adminLink" style="display: none; position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: white; padding: 10px 20px; border-radius: 30px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4);">⚙️ Admin</a>

    <script>
        const SUPABASE_URL = 'https://bmnwirsmmmhknbhvnuyb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbndpcnNtbW1oa25iaHZudXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTQ3OTksImV4cCI6MjA3NDQzMDc5OX0.R-IWO_-i8Ih6WAz0V-ch4mgj1T-lNYWdHJrTeg4c9GE';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let posts = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadPosts();
            if(localStorage.getItem('isAdmin') === 'true') document.getElementById('adminLink').style.display = 'block';
        });

        async function loadPosts() {
            const container = document.getElementById('postsContainer');
            try {
                const { data, error } = await supabaseClient.from('posts').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                posts = (data || []).map(normalizePost);
                renderPosts();
            } catch (error) {
                container.innerHTML = `<div style="text-align:center; color:#999">Error loading posts: ${error.message}</div>`;
            }
        }

        function renderPosts() {
            const container = document.getElementById('postsContainer');
            if (!posts.length) {
                container.innerHTML = `<div style="text-align:center; color:#999">No posts found.</div>`;
                return;
            }
            container.innerHTML = posts.map(post => {
                const { summaryHtml, fullHtml, shouldCollapse } = buildPostSections(post.content);
                
                const expandBtn = shouldCollapse 
                    ? `<button class="btn" onclick="togglePost('${post.id}')" id="btn-${post.id}">
                         <ion-icon name="resize-outline" class="btn-icon"></ion-icon> Expand
                       </button>` 
                    : '';
                
                return `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-meta">${post.date} ${post.type ? `• ${post.type}` : ''}</div>
                        <div class="post-title">${escapeHtml(post.title)}</div>
                    </div>
                    <div class="post-content">
                        ${post.image ? `<img src="${escapeHtml(post.image)}" class="post-image">` : ''}
                        <div id="summary-${post.id}" class="post-summary">${summaryHtml}</div>
                        <div id="full-${post.id}" class="post-full">${fullHtml}</div>
                    </div>
                    <div class="post-actions">
                        ${expandBtn}
                        <button class="btn" onclick="copyContent('${post.id}')">
                            <ion-icon name="copy-outline" class="btn-icon"></ion-icon> Copy Content
                        </button>
                    </div>
                </div>`;
            }).join('');
            
            if(window.Prism) Prism.highlightAll();
        }

        function togglePost(id) {
            const full = document.getElementById(`full-${id}`);
            const summary = document.getElementById(`summary-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            
            if (full.classList.contains('is-visible')) {
                full.classList.remove('is-visible');
                summary.classList.remove('is-hidden');
                btn.innerHTML = `<ion-icon name="resize-outline" class="btn-icon"></ion-icon> Expand`;
            } else {
                full.classList.add('is-visible');
                summary.classList.add('is-hidden');
                btn.innerHTML = `<ion-icon name="chevron-up-outline" class="btn-icon"></ion-icon> Collapse`;
            }
        }

        async function copyContent(id) {
            const post = posts.find(p => String(p.id) === String(id));
            if(!post || !post.content) return;
            try {
                await navigator.clipboard.writeText(post.content);
                alert("Copied to clipboard!");
            } catch(e) { alert("Failed to copy."); }
        }

        function normalizePost(post) {
            return {
                id: post.id || Date.now(),
                title: post.title || 'Untitled',
                content: post.content || post.postContent || '',
                date: new Date(post.created_at || Date.now()).toLocaleDateString(),
                image: post.image || null,
                type: post.type || null
            };
        }

        // --- CORE LOGIC FIX ---
        function buildPostSections(raw) {
            if (!raw) return { summaryHtml: '', fullHtml: '', shouldCollapse: false };
            
            const lines = raw.split('\n');
            const LIMIT = 20; // Show 20 lines
            const shouldCollapse = lines.length > LIMIT;
            
            const fullHtml = renderNotionContent(raw);
            
            // Smart truncation: don't cut inside a code block without closing it
            let summaryRaw = raw;
            if (shouldCollapse) {
                const truncatedLines = lines.slice(0, LIMIT);
                
                // Check if we cut in the middle of a code block
                let inCode = false;
                for(let line of truncatedLines) {
                    if(line.trim().startsWith('/code')) inCode = true;
                    if(line.trim().startsWith('/end_code')) inCode = false;
                }
                
                if(inCode) {
                    truncatedLines.push('... (code truncated)');
                    truncatedLines.push('/end_code');
                } else {
                    truncatedLines.push('...');
                }
                summaryRaw = truncatedLines.join('\n');
            }

            const summaryHtml = shouldCollapse ? renderNotionContent(summaryRaw) : fullHtml;
            return { summaryHtml, fullHtml, shouldCollapse };
        }

        function renderNotionContent(text) {
            if (!text) return '';

            // 1. Split text into segments: Code blocks vs Normal text
            // Regex to find /code ... /end_code blocks across multiple lines
            const parts = text.split(/(\/code\s*\w*[\s\S]*?\/end_code)/g);

            return parts.map(part => {
                if (part.trim().startsWith('/code')) {
                    // -- HANDLE CODE BLOCK --
                    // Extract language
                    const match = part.match(/\/code\s*(\w*)/);
                    const lang = match ? match[1] : 'plaintext';
                    
                    // Clean tags
                    let code = part.replace(/\/code\s*\w*/, '').replace(/\/end_code/, '').trim();
                    
                    // Escape HTML inside code, but DO NOT replace \n with <br>
                    code = escapeHtml(code);
                    
                    return `<pre class="notion-code"><code class="language-${lang}">${code}</code></pre>`;
                } else {
                    // -- HANDLE NORMAL TEXT --
                    let html = escapeHtml(part);
                    
                    // Apply Markdown
                    html = html
                        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                        .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                        .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
                        .replace(/\*(.*)\*/gim, '<i>$1</i>')
                        .replace(/\n/g, '<br>'); // Only use <br> here!
                    
                    return html;
                }
            }).join('');
        }

        function escapeHtml(text) {
            return (text || '').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }
    </script>
</body>
</html>