<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Zhihao Shu</title>
    <link rel="icon" type="image/svg+xml" href="../images/favicon.svg">
    <link rel="alternate icon" href="../images/favicon.ico">
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png">
    
    <!-- Google Fonts for code editor -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.5/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Georgia, serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .nav-header {
            background: #1a252f;
            padding: 15px 40px;
            border-bottom: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-title {
            color: white;
            font-size: 1.8em;
            font-weight: normal;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-links a.current {
            background: #e74c3c;
        }
        
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }
        
        .main-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
        }
        
        .admin-header {
            background: #1a252f;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .admin-header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .admin-form {
            padding: 30px;
        }

        .editor-workspace {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .auth-banner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            color: #155724;
            font-weight: 600;
        }

        .workspace-grid {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .editor-pane,
        .preview-pane {
            flex: 1 1 0;
        }

        .editor-pane {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .editor-pane label {
            font-weight: bold;
            color: #1a252f;
        }

        .editor-title-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 20px;
            font-weight: 600;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        .editor-title-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .command-hint {
            font-size: 0.9em;
            color: #6c7a89;
        }

        .notion-editor {
            width: 100%;
            min-height: 320px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            padding: 18px;
            font-size: 16px;
            line-height: 1.6;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            resize: none;
            background: #fbfcfe;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .notion-editor:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        .editor-actions {
            display: flex;
            gap: 12px;
        }

        .preview-pane {
            background: #f6f8fb;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 20px;
            position: sticky;
            top: 120px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .preview-header {
            font-weight: 700;
            color: #1a252f;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-empty {
            color: #95a5a6;
            font-style: italic;
            font-size: 0.95em;
        }

        .preview-content {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .preview-content h1,
        .preview-content h2,
        .preview-content h3 {
            color: #1a252f;
            line-height: 1.3;
        }

        .preview-content p {
            color: #34495e;
        }

        .notion-code {
            background: #1e1e2f;
            border-radius: 10px;
            padding: 16px;
            overflow: auto;
            border: 1px solid #2d2d44;
        }

        .notion-code code {
            font-family: 'Fira Code', 'Monaco', 'Cascadia Code', monospace;
            font-size: 14px;
        }

        .post-preview {
            margin-top: 15px;
            padding: 18px;
            background: #fff;
            border: 1px solid #e0e6ed;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .post-summary {
            color: #34495e;
            line-height: 1.6;
        }

        .post-summary p {
            margin: 0 0 10px;
        }

        .post-full {
            margin-top: 6px;
            padding-top: 16px;
            border-top: 1px dashed #dfe6ee;
            display: none;
            flex-direction: column;
            gap: 18px;
        }

        .post-full.is-visible {
            display: flex;
        }

        .post-full p {
            margin: 0;
        }

        .is-hidden {
            display: none !important;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        .form-group textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Fira Code', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            tab-size: 4;
            background: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        .code-editor-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .code-editor {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .code-editor-header {
            background: #1a202c;
            color: #e2e8f0;
            padding: 10px 15px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4a5568;
        }
        
        .language-selector {
            background: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
        }
        
        .code-textarea {
            width: 100%;
            background: #2d3748;
            color: #e2e8f0;
            border: none;
            padding: 15px;
            font-family: 'Fira Code', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 300px;
            outline: none;
            tab-size: 4;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }
        
        .code-textarea:focus {
            box-shadow: inset 0 0 0 2px #4299e1;
        }
        
        .code-preview {
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 6px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .code-preview-header {
            background: #1a202c;
            color: #e2e8f0;
            padding: 8px 15px;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 1px solid #4a5568;
        }
        
        .code-preview-content {
            padding: 0;
            max-height: 400px;
            overflow: auto;
        }
        
        .code-preview pre {
            margin: 0;
            padding: 15px;
            background: transparent;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .code-preview code {
            font-family: 'Fira Code', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Courier New', monospace;
        }
        
        .auto-resize {
            overflow: hidden;
            resize: none;
        }
        
        .editor-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .btn-tool {
            background: #4a5568;
            color: #e2e8f0;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-tool:hover {
            background: #2d3748;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            text-align: center;
            transition: border-color 0.3s, background-color 0.3s;
        }
        
        .file-upload:hover .file-upload-label {
            border-color: #e74c3c;
            background-color: #f9f9f9;
        }
        
        .image-preview {
            margin-top: 15px;
            max-width: 100%;
            display: none;
        }
        
        .image-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #e74c3c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #3498db;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-ai {
            background: #9b59b6;
            color: white;
        }
        
        .btn-ai:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            color: #34495e;
            border: 1px solid #ccd6e0;
        }

        .btn-outline:hover {
            background: #f0f4f8;
            transform: translateY(-1px);
        }
        
        /* Chat Sidebar */
        .chat-sidebar {
            background: white;
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.18);
            display: none;
            flex-direction: column;
            height: auto;
            max-height: 70vh;
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: min(360px, calc(100% - 40px));
            z-index: 1100;
        }

        .chat-sidebar.open {
            display: flex;
        }
        
        .chat-header {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 14px 14px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 400px;
            min-height: 300px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 90%;
        }
        
        .chat-message.user {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }
        
        .chat-message.ai {
            background: #f5f5f5;
            margin-right: auto;
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .chat-send {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .chat-send:hover {
            background: #2980b9;
        }

        .chat-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #3498db, #9b59b6);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 30px rgba(52, 152, 219, 0.4);
            cursor: pointer;
            z-index: 1090;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .chat-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 26px rgba(52, 152, 219, 0.5);
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .api-key-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .api-key-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        /* Posts Display */
        .posts-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        
        .post-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
        }
        
        .post-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .post-meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .post-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .post-image {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .post-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        @media (max-width: 1024px) {
            .workspace-grid {
                flex-direction: column;
            }
            
            .preview-pane {
                position: relative;
                top: 0;
                max-height: none;
            }
            
            .chat-sidebar {
                right: 12px;
                bottom: 88px;
                max-height: 60vh;
                width: min(360px, calc(100% - 32px));
            }

            .chat-toggle {
                right: 12px;
                bottom: 12px;
            }
        }
        
        @media (max-width: 640px) {
            .nav-header {
                padding: 15px 20px;
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .nav-links a {
                margin: 0 8px;
                font-size: 14px;
            }
            
            .container {
                padding: 120px 15px 20px;
            }
            
            .admin-form {
                padding: 20px;
            }
            
            .editor-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .chat-sidebar {
                left: 12px;
                right: 12px;
                width: auto;
                bottom: 80px;
                max-height: 60vh;
            }

            .chat-toggle {
                width: 48px;
                height: 48px;
                bottom: 16px;
                right: 16px;
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="nav-header">
        <div class="nav-title">Admin Panel</div>
        <div class="nav-links">
            <a href="../index.html">Home</a>
            <a href="notes.html">Notes</a>
            <a href="teaching.html">Teaching</a>
            <a href="faq.html">FAQ</a>
            <a href="admin.html" class="current">Admin</a>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="admin-header">
                <h1>Content Management</h1>
                <p>Create and manage your posts with AI assistance</p>
            </div>
            
            <div class="admin-form">
                <!-- API Key Section -->
                <div class="api-key-section">
                    <h3>üîë OpenAI API Configuration</h3>
                    <div class="form-group">
                        <label for="apiKey">OpenAI API Key:</label>
                        <input type="password" id="apiKey" placeholder="Enter your OpenAI API key..." />
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Your API key is stored locally and never sent to any server except OpenAI.
                        </small>
                    </div>
                </div>

                <!-- Authentication -->
                <div class="form-group" id="authSection">
                    <label for="adminPassword">Admin Password:</label>
                    <input type="password" id="adminPassword" placeholder="Enter admin password..." />
                    <button type="button" class="btn btn-primary" onclick="authenticate()" style="margin-top: 10px;">
                        Login
                    </button>
                </div>

                <!-- Post Creation Form (Hidden initially) -->
                <div id="postForm" style="display: none;">
                    <div class="editor-workspace">
                        <div class="auth-banner">
                            <span>‚úÖ Authenticated as Admin</span>
                            <button type="button" class="btn btn-secondary" onclick="logout()" style="background: #6c757d;">
                                Logout
                            </button>
                        </div>

                        <div class="workspace-grid">
                            <div class="editor-pane">
                                <div>
                                    <label for="postTitle">Page Title</label>
                                    <input type="text" id="postTitle" class="editor-title-input" placeholder="Untitled" />
                                </div>
                                <div class="command-hint">Tip: Type <strong>/code</strong> followed by an optional language (e.g. <strong>/code python</strong>) to start a code block, and finish it with <strong>/end_code</strong>.</div>
                                <textarea 
                                    id="notionEditor" 
                                    class="notion-editor"
                                    placeholder="Start writing your thoughts, plans, or code snippets..."
                                    oninput="handleEditorInput()"
                                    onkeydown="handleTabKey(event)"
                                ></textarea>
                                <div class="editor-actions">
                                    <button type="button" id="savePostBtn" class="btn btn-primary" onclick="savePost()">
                                        üíæ Save Page
                                    </button>
                                    <button type="button" class="btn btn-ai" onclick="improveWithAI()">
                                        ü§ñ Improve with AI
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="clearForm()" style="background: #6c757d;">
                                        üóëÔ∏è Clear
                                    </button>
                                </div>
                            </div>

                            <div class="preview-pane">
                                <div class="preview-header">
                                    <span>Live Preview</span>
                                    <span style="font-size: 0.85em; color: #6c7a89;">Auto-updates as you type</span>
                                </div>
                                <div id="previewContent" class="preview-content">
                                    <p class="preview-empty">Start typing on the left to see your page build in real time.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posts Display -->
                <div id="postsSection" class="posts-section" style="display: none;">
                    <h2>Your Posts</h2>
                    <div id="postsList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chatSidebar" class="chat-sidebar" aria-hidden="true">
        <div class="chat-header">
            <span>ü§ñ AI Assistant</span>
            <button type="button" class="chat-close" aria-label="Close chat" onclick="toggleChat(false)">&times;</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message ai">
                Hi! I'm your AI assistant. I can help you improve your posts, generate code, or answer questions. Make sure to set your OpenAI API key first!
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything..." 
                   onkeypress="if(event.key==='Enter') sendMessage()" />
            <button class="chat-send" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <button id="chatToggle" class="chat-toggle" type="button" aria-label="Open AI assistant" onclick="toggleChat(true)">ü§ñ</button>

        <script>
        const ADMIN_PASSWORD = 'zhihao1997';
        const SUPABASE_URL = 'https://bmnwirsmmmhknbhvnuyb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbndpcnNtbW1oa25iaHZudXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTQ3OTksImV4cCI6MjA3NDQzMDc5OX0.R-IWO_-i8Ih6WAz0V-ch4mgj1T-lNYWdHJrTeg4c9GE';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isAuthenticated = false;
        let posts = [];
        let apiKey = localStorage.getItem('openaiApiKey') || '';
        let isChatOpen = false;

            document.addEventListener('DOMContentLoaded', async () => {
                const apiKeyInput = document.getElementById('apiKey');
                if (apiKeyInput) {
                    if (apiKey) {
                        apiKeyInput.value = apiKey;
                    }
                    apiKeyInput.addEventListener('change', (event) => {
                        apiKey = event.target.value.trim();
                        localStorage.setItem('openaiApiKey', apiKey);
                    });
                }

                if (localStorage.getItem('isAdminAuthenticated') === 'true') {
                    isAuthenticated = true;
                }

                await toggleAdminUI(isAuthenticated);
                initializeEditor();
                handleEditorInput();

                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', (event) => {
                        if (event.key === 'Enter') {
                            sendMessage();
                        }
                    });
                }

                toggleChat(false);
                document.addEventListener('keydown', handleGlobalKeydown);
            });

            function normalizePost(post) {
                if (!post || typeof post !== 'object') {
                    return {
                        id: `post-${Date.now()}`,
                        title: 'Untitled',
                        content: '',
                        timestamp: Date.now(),
                        date: new Date().toLocaleDateString(),
                        image: null
                    };
                }

                const createdAt = post.created_at ? new Date(post.created_at) : (post.timestamp ? new Date(post.timestamp) : new Date());
                const timestamp = createdAt.getTime();

                return {
                    id: post.id || post.uuid || `post-${timestamp}`,
                    title: post.title || 'Untitled',
                    content: post.content || post.postContent || post.code || '',
                    timestamp,
                    date: post.date || createdAt.toLocaleDateString(),
                    image: post.image || post.cover_url || null
                };
            }

            async function toggleAdminUI(authenticated) {
                const authSection = document.getElementById('authSection');
                const postForm = document.getElementById('postForm');
                const postsSection = document.getElementById('postsSection');

                if (authenticated) {
                    if (authSection) authSection.style.display = 'none';
                    if (postForm) postForm.style.display = 'block';
                    if (postsSection) postsSection.style.display = 'block';
                    await loadPosts(true);
                    handleEditorInput();
                } else {
                    if (authSection) authSection.style.display = 'block';
                    if (postForm) postForm.style.display = 'none';
                    if (postsSection) postsSection.style.display = 'none';
                    posts = [];
                    const postsList = document.getElementById('postsList');
                    if (postsList) postsList.innerHTML = '';
                }
            }

            async function authenticate() {
                const passwordInput = document.getElementById('adminPassword');
                const password = passwordInput ? passwordInput.value : '';

                if (password === ADMIN_PASSWORD) {
                    isAuthenticated = true;
                    localStorage.setItem('isAdminAuthenticated', 'true');
                    await toggleAdminUI(true);
                    if (passwordInput) passwordInput.value = '';
                } else {
                    alert('Incorrect password!');
                }
            }

            async function logout() {
                isAuthenticated = false;
                localStorage.removeItem('isAdminAuthenticated');
                const passwordInput = document.getElementById('adminPassword');
                if (passwordInput) passwordInput.value = '';
                await toggleAdminUI(false);
            }

            function initializeEditor() {
                const textarea = document.getElementById('notionEditor');
                if (!textarea || textarea.dataset.initialized === 'true') return;

                textarea.dataset.initialized = 'true';
                autoResizeTextarea(textarea);
            }

            function handleEditorInput() {
                autoResizeTextarea();
                updatePreview();
            }

            function autoResizeTextarea(element) {
                const textarea = element || document.getElementById('notionEditor');
                if (!textarea) return;

                textarea.style.height = 'auto';
                const minHeight = 320;
                const maxHeight = window.innerHeight * 0.65;
                const scrollHeight = textarea.scrollHeight;
                const newHeight = Math.max(minHeight, Math.min(scrollHeight + 12, maxHeight));
                textarea.style.height = `${newHeight}px`;
                textarea.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden';
            }

            function updatePreview() {
                const preview = document.getElementById('previewContent');
                const textarea = document.getElementById('notionEditor');
                if (!preview || !textarea) return;

                const content = textarea.value || '';
                const rendered = renderNotionContent(content);

                if (rendered) {
                    preview.innerHTML = rendered;
                } else {
                    preview.innerHTML = '<p class="preview-empty">Start typing on the left to see your page build in real time.</p>';
                }

                highlightWithin(preview);
            }

            function renderNotionContent(raw) {
                if (!raw || !raw.trim()) {
                    return '';
                }

                const normalized = raw.replace(/\r\n/g, '\n');
                const lines = normalized.split('\n');
                const blocks = [];
                let buffer = [];
                let withinCode = false;
                let codeHeader = '';
                let codeLines = [];

                const pushBuffer = () => {
                    if (buffer.length) {
                        blocks.push(buffer.join('\n'));
                        buffer = [];
                    }
                };

                lines.forEach(line => {
                    const trimmed = line.trim();
                    const lower = trimmed.toLowerCase();

                    if (withinCode) {
                        if (lower === '/end_code') {
                            blocks.push([codeHeader, ...codeLines].join('\n'));
                            withinCode = false;
                            codeHeader = '';
                            codeLines = [];
                        } else {
                            codeLines.push(line);
                        }
                        return;
                    }

                    if (lower.startsWith('/code')) {
                        pushBuffer();
                        withinCode = true;
                        codeHeader = trimmed;
                        codeLines = [];
                        return;
                    }

                    if (trimmed === '') {
                        pushBuffer();
                        return;
                    }

                    buffer.push(line);
                });

                pushBuffer();

                if (withinCode) {
                    blocks.push([codeHeader, ...codeLines].join('\n'));
                }

                return blocks
                    .map(block => renderBlock(block.trim()))
                    .filter(Boolean)
                    .join('');
            }

            function renderSummaryContent(raw) {
                if (!raw || !raw.trim()) {
                    return '';
                }

                const normalized = raw.replace(/\r\n/g, '\n');
                const lines = normalized.split('\n');
                let summary = '';
                let withinCode = false;
                let codeLanguage = 'code';

                for (let i = 0; i < lines.length; i++) {
                    const original = lines[i];
                    const trimmed = original.trim();
                    if (!trimmed) {
                        continue;
                    }

                    const lowered = trimmed.toLowerCase();

                    if (withinCode) {
                        if (lowered === '/end_code') {
                            withinCode = false;
                        }
                        continue;
                    }

                    if (lowered.startsWith('/code')) {
                        withinCode = true;
                        const parts = trimmed.split(/\s+/);
                        codeLanguage = parts[1] ? parts[1].toUpperCase() : 'CODE';
                        summary = `Code snippet (${codeLanguage})`;
                        break;
                    }

                    let sanitized = trimmed;
                    sanitized = sanitized.replace(/^#+\s+/, '');
                    sanitized = sanitized.replace(/^>\s+/, '');
                    sanitized = sanitized.replace(/^[-*]\s+/, '');
                    sanitized = sanitized.replace(/^\d+\.\s+/, '');
                    sanitized = sanitized.trim();
                    if (!sanitized) {
                        continue;
                    }

                    summary += (summary ? ' ' : '') + sanitized;
                    if (summary.length >= 240) {
                        break;
                    }
                }

                if (!summary) {
                    summary = `Code snippet (${codeLanguage.toUpperCase()})`;
                }

                summary = summary.trim();
                if (summary.length > 240) {
                    summary = summary.slice(0, 237).trim() + '‚Ä¶';
                }

                return `<p>${escapeHtml(summary)}</p>`;
            }

            function renderBlock(block) {
                if (!block) return '';

                const lines = block.split('\n');
                const firstLine = lines[0].trim();

                if (firstLine.startsWith('/code')) {
                    const parts = firstLine.split(/\s+/);
                    const language = (parts[1] || 'plaintext').toLowerCase();
                    const code = lines.slice(1).join('\n');
                    return `<pre class="notion-code"><code class="language-${language}">${escapeHtml(code)}</code></pre>`;
                }

                if (firstLine.startsWith('### ')) {
                    return `<h3>${escapeHtml(firstLine.slice(4))}</h3>`;
                }

                if (firstLine.startsWith('## ')) {
                    return `<h2>${escapeHtml(firstLine.slice(3))}</h2>`;
                }

                if (firstLine.startsWith('# ')) {
                    return `<h1>${escapeHtml(firstLine.slice(2))}</h1>`;
                }

                if (lines.every(line => line.trim().startsWith('- '))) {
                    const items = lines
                        .map(line => `<li>${escapeHtml(line.trim().slice(2))}</li>`)
                        .join('');
                    return `<ul>${items}</ul>`;
                }

                if (lines.every(line => /^\d+\.\s+/.test(line.trim()))) {
                    const items = lines
                        .map(line => {
                            const text = line.trim().replace(/^\d+\.\s+/, '');
                            return `<li>${escapeHtml(text)}</li>`;
                        })
                        .join('');
                    return `<ol>${items}</ol>`;
                }

                if (lines.every(line => line.trim().startsWith('> '))) {
                    const content = lines
                        .map(line => escapeHtml(line.trim().slice(2)))
                        .join('<br>');
                    return `<blockquote>${content}</blockquote>`;
                }

                const paragraph = lines
                    .map(line => escapeHtml(line))
                    .join('<br>');
                return `<p>${paragraph}</p>`;
            }

            function escapeHtml(text) {
                return String(text || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function highlightWithin(element) {
                if (!window.Prism || !element) return;
                const codeBlocks = element.querySelectorAll('code');
                codeBlocks.forEach(block => window.Prism.highlightElement(block));
            }

            async function savePost() {
                if (!isAuthenticated) {
                    alert('Please authenticate first!');
                    return;
                }

                const titleInput = document.getElementById('postTitle');
                const editor = document.getElementById('notionEditor');
                const saveBtn = document.getElementById('savePostBtn');
                if (!titleInput || !editor) return;

                const title = titleInput.value.trim() || 'Untitled';
                const content = editor.value.trim();

                if (!content) {
                    alert('Please add some content before saving.');
                    return;
                }

                try {
                    if (saveBtn) {
                        saveBtn.textContent = 'üíæ Saving...';
                        saveBtn.disabled = true;
                    }

                    const { error } = await supabaseClient
                        .from('posts')
                        .insert([{ title, content }]);

                    if (error) {
                        throw error;
                    }

                    await loadPosts(false);
                    alert('Page saved successfully!');
                    clearForm();
                } catch (error) {
                    console.error('Failed to save post:', error);
                    alert('Error saving post: ' + error.message);
                } finally {
                    if (saveBtn) {
                        saveBtn.textContent = 'üíæ Save Page';
                        saveBtn.disabled = false;
                    }
                }
            }

            async function loadPosts(showLoading = false) {
                const postsSection = document.getElementById('postsSection');
                const postsList = document.getElementById('postsList');
                if (!postsSection || !postsList) return;

                if (showLoading) {
                    postsList.innerHTML = '<p style="text-align: center; color: #666;">Loading posts...</p>';
                }

                try {
                    const { data, error } = await supabaseClient
                        .from('posts')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) {
                        throw error;
                    }

                    posts = (data || []).map(normalizePost);

                    postsList.innerHTML = '';

                    if (!posts.length) {
                        postsList.innerHTML = '<p style="text-align: center; color: #666;">No pages yet. Start creating on the left!</p>';
                        return;
                    }

                    posts.forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.className = 'post-item';

                        const rendered = renderNotionContent(post.content);
                        const summary = renderSummaryContent(post.content);
                        const summaryHtml = summary || '<p style="color:#7f8c8d; margin:0;">(No content)</p>';
                        const fullHtml = rendered || '<p style="color:#7f8c8d; margin:0;">(No content)</p>';
                        const postId = post.id;
                        const postIdJson = JSON.stringify(postId);

                        postElement.innerHTML = `
                            <div class="post-title">${escapeHtml(post.title)}</div>
                            <div class="post-meta">Created: ${escapeHtml(post.date)}</div>
                            ${post.image ? `<img src="${post.image}" alt="Post image" class="post-image">` : ''}
                            <div class="post-preview">
                                <div class="post-summary" id="postSummary-${postId}">${summaryHtml}</div>
                                <div class="post-full" id="postFull-${postId}">${fullHtml}</div>
                            </div>
                            <div class="post-actions">
                                <button class="btn btn-secondary btn-small" id="toggleBtn-${postId}" onclick='togglePostContent(${postIdJson})'>View full</button>
                                <button class="btn btn-outline btn-small" onclick='copyPostContent(${postIdJson})'>Copy content</button>
                                <button class="btn btn-danger btn-small" onclick='deletePost(${postIdJson})'>Delete</button>
                            </div>
                        `;

                        postsList.appendChild(postElement);
                        highlightWithin(postElement);
                    });
                } catch (error) {
                    console.error('Failed to load posts:', error);
                    postsList.innerHTML = `<p style="color:#e74c3c; text-align:center;">Failed to load posts: ${escapeHtml(error.message)}</p>`;
                }
            }

            async function deletePost(id) {
                if (!confirm('Are you sure you want to delete this page?')) {
                    return;
                }

                try {
                    const { error } = await supabaseClient
                        .from('posts')
                        .delete()
                        .eq('id', id);

                    if (error) {
                        throw error;
                    }

                    await loadPosts(false);
                } catch (error) {
                    console.error('Failed to delete post:', error);
                    alert('Error deleting post: ' + error.message);
                }
            }

            function clearForm() {
                const titleInput = document.getElementById('postTitle');
                const editor = document.getElementById('notionEditor');
                if (titleInput) titleInput.value = '';
                if (editor) editor.value = '';
                handleEditorInput();
            }

            async function improveWithAI() {
                const editor = document.getElementById('notionEditor');
                const titleInput = document.getElementById('postTitle');

                if (!editor || !titleInput) return;

                if (!apiKey.trim()) {
                    alert('Please enter your OpenAI API key first!');
                    const apiKeyField = document.getElementById('apiKey');
                    if (apiKeyField) apiKeyField.focus();
                    return;
                }

                const content = editor.value.trim();
                if (!content) {
                    alert('Please add some content to improve.');
                    return;
                }

                const title = titleInput.value.trim() || 'Untitled';
                const improveBtn = document.querySelector('.btn-ai');
                const originalText = improveBtn ? improveBtn.textContent : '';

                if (improveBtn) {
                    improveBtn.textContent = 'ü§ñ Improving...';
                    improveBtn.disabled = true;
                }

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{
                                role: 'user',
                                content: `You are helping me polish a personal knowledge base page. Keep the Notion-style formatting, start code blocks with "/code [language]" and close them with "/end_code". Improve clarity, structure, and style without inventing facts.\n\nTitle: ${title}\n\nContent:\n${content}`
                            }],
                            max_tokens: 1000,
                            temperature: 0.6
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const improved = data.choices[0].message.content.trim();
                    const extracted = extractTitleAndContent(improved, title);

                    titleInput.value = extracted.title;
                    editor.value = extracted.content;
                    handleEditorInput();

                    alert('Content improved successfully!');
                } catch (error) {
                    console.error('AI improvement failed:', error);
                    alert('Error improving content: ' + error.message);
                } finally {
                    if (improveBtn) {
                        improveBtn.textContent = originalText;
                        improveBtn.disabled = false;
                    }
                }
            }

            function extractTitleAndContent(responseText, fallbackTitle) {
                const lines = responseText.split('\n');
                let newTitle = fallbackTitle;
                let contentLines = [];

                lines.forEach(line => {
                    if (line.toLowerCase().startsWith('title:')) {
                        newTitle = line.replace(/title:\s*/i, '').trim() || newTitle;
                    } else {
                        contentLines.push(line);
                    }
                });

                const cleanedContent = contentLines.join('\n').trim() || responseText;
                return { title: newTitle, content: cleanedContent };
            }

            function toggleChat(forceState) {
                const chatSidebar = document.getElementById('chatSidebar');
                const chatToggle = document.getElementById('chatToggle');
                if (!chatSidebar) return;

                if (typeof forceState === 'boolean') {
                    isChatOpen = forceState;
                } else {
                    isChatOpen = !isChatOpen;
                }

                if (isChatOpen) {
                    chatSidebar.classList.add('open');
                    chatSidebar.setAttribute('aria-hidden', 'false');
                    if (chatToggle) {
                        chatToggle.setAttribute('aria-expanded', 'true');
                        chatToggle.style.display = 'none';
                    }
                    setTimeout(() => {
                        const input = document.getElementById('chatInput');
                        if (input) input.focus();
                    }, 150);
                } else {
                    chatSidebar.classList.remove('open');
                    chatSidebar.setAttribute('aria-hidden', 'true');
                    if (chatToggle) {
                        chatToggle.setAttribute('aria-expanded', 'false');
                        chatToggle.style.display = 'flex';
                    }
                }
            }

            function handleGlobalKeydown(event) {
                if (event.key === 'Escape' && isChatOpen) {
                    toggleChat(false);
                }
            }

            function togglePostContent(id) {
                const summaryEl = document.getElementById(`postSummary-${id}`);
                const fullEl = document.getElementById(`postFull-${id}`);
                const toggleBtn = document.getElementById(`toggleBtn-${id}`);
                if (!summaryEl || !fullEl || !toggleBtn) {
                    return;
                }

                const isExpanded = fullEl.classList.contains('is-visible');

                if (isExpanded) {
                    fullEl.classList.remove('is-visible');
                    summaryEl.classList.remove('is-hidden');
                    toggleBtn.textContent = 'View full';
                } else {
                    fullEl.classList.add('is-visible');
                    summaryEl.classList.add('is-hidden');
                    toggleBtn.textContent = 'Hide';
                    highlightWithin(fullEl);
                }
            }

            async function copyPostContent(id) {
                const post = posts.find(item => String(item.id) === String(id));
                if (!post || !post.content) {
                    alert('No content available to copy.');
                    return;
                }

                const textToCopy = post.content;

                try {
                    await navigator.clipboard.writeText(textToCopy);
                    alert('Post content copied to clipboard!');
                } catch (error) {
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        alert('Post content copied to clipboard!');
                    } catch (fallbackError) {
                        console.error('Copy failed:', fallbackError);
                        alert('Unable to copy content. Please copy manually.');
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            }

            async function sendMessage() {
                const input = document.getElementById('chatInput');
                if (!input) return;

                if (!apiKey.trim()) {
                    alert('Please enter your OpenAI API key first!');
                    const apiKeyField = document.getElementById('apiKey');
                    if (apiKeyField) apiKeyField.focus();
                    return;
                }

                if (!isChatOpen) {
                    toggleChat(true);
                }

                const message = input.value.trim();
                if (!message) return;

                addChatMessage(message, 'user');
                input.value = '';

                const loadingId = addChatMessage('Thinking...', 'ai');

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{ role: 'user', content: message }],
                            max_tokens: 500,
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const reply = data.choices[0].message.content.trim();
                    const loadingEl = document.getElementById(loadingId);
                    if (loadingEl) loadingEl.textContent = reply;
                } catch (error) {
                    console.error('Chat error:', error);
                    const loadingEl = document.getElementById(loadingId);
                    if (loadingEl) loadingEl.textContent = 'Sorry, I encountered an error: ' + error.message;
                }
            }

            function addChatMessage(message, sender) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return '';

                const messageId = 'msg-' + Date.now();
                const element = document.createElement('div');
                element.id = messageId;
                element.className = `chat-message ${sender}`;
                element.textContent = message;
                messagesContainer.appendChild(element);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return messageId;
            }

            function handleTabKey(event) {
                if (event.key !== 'Tab') return;

                event.preventDefault();
                const textarea = event.target;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const tabCharacters = '    ';

                textarea.value = textarea.value.substring(0, start) + tabCharacters + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + tabCharacters.length;

                handleEditorInput();
            }
        </script>
</body>
</html>